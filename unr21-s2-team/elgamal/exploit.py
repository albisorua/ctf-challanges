from pwn import *
from gmpy2 import *

def elgamal_gen_x_and_h(q, g):
    x = random.randrange(1, q-1)
    h = pow(g, x, q)
    return (h, x)

io = remote("34.159.190.67", 30289)

msg = io.recvuntil(b'? ')

msg = msg.split(b"\n")[-1]

msg = msg.split(b' ')

q = int(msg[1][2:].decode('utf-8'))

g = int(msg[3][2:7].decode('utf-8'))

(h, x) = elgamal_gen_x_and_h(q, g)

io.sendline(str(x))

msg = io.recvuntil(b"h: ")

io.sendline(str(h))

msg = io.recvuntil(b": ")

m = int("0x6869", 16)

io.sendline(str(m))

msg = io.recvuntil(b"? ")

y = random.randrange(1, q)

io.sendline(str(y))

msg = io.recvuntil(b"s: ")

s = pow(h, y, q)

io.sendline(str(s))

msg = io.recvuntil(b"c1: ")

c1 = pow(g, y, q)

io.sendline(str(c1))

msg = io.recvuntil(b"c2: ")

c2 = s * m % q

io.sendline(str(c2))

msg = io.recvline()

msg = io.recvline()

msg = msg.split(b"=")[1].lstrip(b" (").rstrip(b")\n").split(b", ")

public = [int(el.decode("utf-8")) for el in msg]

q = public[0]
g = public[1]
h = public[2]

msg = io.recvline()

msg = msg.split(b"=")[1].lstrip(b" (").rstrip(b")\n").split(b", ")

cipher = [int(el.decode("utf-8")) for el in msg]

c1 = cipher[0]
c2 = cipher[1]

msg = io.recvline()

msg = msg.split(b": ")[1].rstrip(b"\n")

x = int(msg.decode("utf-8"))

s = pow(c1, x, q)

msg = io.recvuntil(b": ")

io.sendline(str(s))

msg = io.recvuntil(b"s_inv: ")

s_inv = pow(s, -1, q)

io.sendline(str(s_inv))

msg = io.recvuntil(b": ")

m = bytes.fromhex(hex(c2 * s_inv % q)[2:]).decode('ASCII')

io.sendline(m)

msg = io.recvline()

print(msg)

io.close()
